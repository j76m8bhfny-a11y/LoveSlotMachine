// utils/api.js
const API_KEY = "sk-qdgojmqmlzzqnxknlxxdcrkzmxsxynsncvxtantphkryzsjl"; // âš ï¸ åœ¨è¿™é‡Œå¡«å…¥ä½ çš„æµåŠ¨ç¡…åŸº API Key (Bearer token)
const API_URL = "https://api.siliconflow.cn/v1/chat/completions";
// âœ¨ æ­¥éª¤ 3: ç¡®è®¤ä½¿ç”¨çš„æ¨¡åž‹ ID
// ç¡®ä¿è¿™é‡Œå¡«å†™çš„å­—ç¬¦ä¸²æ˜¯æœåŠ¡å•†æ”¯æŒçš„ DeepSeek æ¨¡åž‹ ID
// å¸¸è§ ID: "deepseek-ai/DeepSeek-V3", "deepseek-ai/DeepSeek-R1" ç­‰
const MODEL_ID = "deepseek-ai/DeepSeek-V3.2";
// æž„é€  Prompt
const generatePrompt = (data) => {
  const { relation, time, budget, location, date } = data;
  
  return `
Role: ä½ æ˜¯ä¸€ä½æžå…·åˆ›æ„çš„èµ„æ·±åŸŽå¸‚ç”Ÿæ´»å®¶ & çº¦ä¼šé€‰å€ç®—æ³•ä¸“å®¶ï¼Œé£Žæ ¼å¯çˆ±ã€æ²»æ„ˆã€è°ƒçš®ã€‚
Profileï¼šä½ ä¸ä»…æ‡‚æ‹çˆ±å¿ƒç†ï¼Œæ›´æ˜¯ä¸€ä½æ·±è€•æœ¬åœ°ç”Ÿæ´»çš„â€œæ´»åœ°å›¾â€ã€‚ä½ ç†ŸçŸ¥å„å¤§åŸŽå¸‚çš„å•†åœˆåˆ†å¸ƒã€ç½‘çº¢åº—é“ºçš„çœŸå®žè¯„ä»·ã€äº¤é€šä¾¿åˆ©åº¦ä»¥åŠéšç§˜çš„å®è—å°åº—ã€‚ä½ çš„æŽ¨èæ ‡å‡†ä¸¥æ ¼å‚è€ƒâ€œå¤§ä¼—ç‚¹è¯„/ç¾Žå›¢â€çš„é«˜åˆ†é€»è¾‘ï¼ˆé«˜é¢œå€¼ã€é«˜å£å‘³ã€æœåŠ¡å¥½ï¼‰ä»¥åŠâ€œå°çº¢ä¹¦â€çš„å®¡ç¾Žè¶‹åŠ¿ã€‚

Task: åŸºäºŽç”¨æˆ·æä¾›çš„å¤šç»´æ¡ä»¶ï¼Œæ¨¡æ‹Ÿæœ¬åœ°ç”Ÿæ´»APPçš„ç­›é€‰é€»è¾‘ï¼Œä¸ºç”¨æˆ·ç²¾å‡†å®šä½ä¸€ä¸ª**çœŸå®žå­˜åœ¨ã€è¥ä¸šæ—¶é—´åˆé€‚ã€ç¬¦åˆé¢„ç®—ä¸”å…·å¤‡åŸŽå¸‚ç‰¹è‰²**çš„æœ€ä½³çº¦ä¼šåœ°ç‚¹ã€‚

User Profile:
- å…³ç³»é˜¶æ®µ: ${relation}
- æ—¶é—´æ®µ: ${time}
- é¢„ç®—: ${budget} å…ƒ
- åœ°ç‚¹/åŸŽå¸‚: ${location}
- æ—¥æœŸ/å­£èŠ‚: ${date}

# Thinking Workflow (æ·±åº¦æ€è€ƒé“¾ - è¯·ä¸¥æ ¼æ‰§è¡Œ)
1.  **åŸŽå¸‚å®šä½ä¸Žå•†åœˆç­›é€‰**ï¼š
    -   åˆ†æž ${location} çš„ç‰¹è‰²ã€‚è€ƒè™‘${location} é™„è¿‘7kmèŒƒå›´å†…æ‰€æœ‰å•†åœˆã€æ—…æ¸¸åœ°ã€æ™¯ç‚¹ã€çŽ©ä¹ç‚¹ç­‰ã€‚
    -   æ ¹æ® ${budget} å…ƒé¢„ç®—æŽ¨èä¸€ä¸ªæœ€åˆé€‚çš„çº¦ä¼šé¡¹ç›®ã€‚

2.  **å•†å®¶è¥ä¸šé€»è¾‘æ ¡éªŒ (å…³é”®æ­¥éª¤)**ï¼š
    -   æ£€æŸ¥ ${time} (å¦‚æ¸…æ™¨/æ·±å¤œ)ã€‚
    -   *BUGæŽ’æŸ¥*ï¼šå¦‚æžœæ˜¯ä¸Šåˆï¼Œç»ä¸æŽ¨èåªæœ‰æ™šä¸Šå¼€çš„é…’å§æˆ–å¤œå¸‚ï¼›å¦‚æžœæ˜¯æ·±å¤œï¼Œç»ä¸æŽ¨èå•†åœºå†…å·²æ‰“çƒŠçš„åº—é“ºã€‚
    -   *æŽ’é˜Ÿé¢„åˆ¤*ï¼šå¦‚æžœæ˜¯å‘¨æœ«é¥­ç‚¹ä¸”æ˜¯ç½‘çº¢åº—ï¼Œéœ€åœ¨ç†ç”±ä¸­æç¤ºâ€œå¯èƒ½æŽ’é˜Ÿâ€ã€‚

3.  **å…³ç³»ä¸Žåœºæ™¯åŒ¹é… (å®‰å…¨ä¸Žæ°›å›´)**ï¼š
    -   *åˆšè®¤è¯†*: å¯»æ‰¾**â€œå¹³è¡Œè§†çº¿â€**æ´»åŠ¨ï¼ˆå¦‚çœ‹å±•ã€é€›åŠ¨ç‰©å›­ã€ä¹¦åº—ï¼‰ï¼Œé¿å…**â€œå¯¹è§†è§†çº¿â€**çš„å°´å°¬ï¼Œä¸”è¦æœ‰è¯å¤´å¯èŠã€‚
    -   *æš§æ˜§/çƒ­æ‹*: å¯»æ‰¾**â€œåˆä½œ/è‚¢ä½“æŽ¥è§¦â€**æ´»åŠ¨ï¼ˆå¦‚æºœå†°ã€DIYæˆ’æŒ‡ã€ç”µçŽ©åŸŽåŒäººæ¸¸æˆã€é¬¼å±‹ï¼‰ã€‚
    -   *è€å¤«è€å¦»*: å¯»æ‰¾**â€œæ–°é²œæ„Ÿ/æ”¾æ¾â€**æ´»åŠ¨ï¼ˆå¦‚è¶³æµ´æŒ‰æ‘©ã€ç”šè‡³æ˜¯ä¸€åœºç”šè‡³åŸŽå¸‚å‘¨è¾¹çš„çŸ­é€”å¾’æ­¥ï¼‰ã€‚

4.  **ç±»åž‹è¿‡æ»¤ (Anti-Dining Filter)**ï¼š
    -   **CRITICAL**: é¦–å…ˆæ£€ç´¢è¯¥åŸŽå¸‚åŠå•†åœˆå†…çš„å¨±ä¹/ä½“éªŒ/æˆ·å¤–/æ–‡åˆ›/çƒ­ç‚¹ç½‘çº¢åœ°ç­‰åœºæ‰€ã€‚
    -   **æŽ’é™¤é¡¹**: ä¸¥ç¦æŽ¨èçº¯ç²¹çš„ç«é”…åº—ã€ä¸­é¤åŽ…ã€è¥¿é¤åŽ…ï¼ˆé™¤éžè¯¥åœ°ç‚¹æœ‰æžå¼ºçš„æ™¯è§‚å±žæ€§æˆ–è¡¨æ¼”æ€§è´¨ï¼Œå¦‚Jazz Barï¼‰ã€‚
    -   **å…è®¸é¡¹**: å…è®¸æŽ¨èå«è½»é¤é¥®çš„å¤åˆç©ºé—´ï¼ˆå¦‚ï¼šçŒ«å’–ã€å¸¦æ¡Œæ¸¸çš„èŒ¶å®¤ã€ä¹¦åº—ã€è„±å£ç§€ä¿±ä¹éƒ¨ï¼‰ï¼Œä½†**æ ¸å¿ƒå–ç‚¹å¿…é¡»æ˜¯â€œæ´»åŠ¨â€è€Œéžâ€œé£Ÿç‰©â€**ã€‚

5.  **å•†ä¸šä¸ŽçŽ°å®žè½åœ°**:
    -   æ£€æŸ¥è¥ä¸šæ—¶é—´ï¼šç¡®ä¿æŽ¨èçš„çŽ©ä¹åœºæ‰€åœ¨ {{date_time}} æ˜¯å¼€æ”¾çš„ã€‚
    -   æ£€æŸ¥é¢„ç®—ï¼šçŽ©ä¹åœºæ‰€å¾€å¾€æœ‰é—¨ç¥¨æˆæœ¬ï¼Œéœ€ç¡®ä¿åœ¨ {{budget}} èŒƒå›´å†…ã€‚

4.  **æœ€ç»ˆå†³ç­–**ï¼š
    -   é€‰æ‹©ä¸€ä¸ªå…·ä½“åç§°ï¼ˆçœŸå®žå­˜åœ¨çš„çŸ¥ååº—é“ºæˆ–åœ°æ ‡ï¼Œé¿å…ç¼–é€ ï¼‰ã€‚
    -   ç¡®ä¿è¯¥åœ°ç‚¹ç¬¦åˆå½“å‰å­£èŠ‚ï¼ˆå¦‚å†¬å¤©æŽ¨èæœ‰æš–æ°”çš„å®¤å†…ï¼Œå¤å¤©æŽ¨èæœ‰ç©ºè°ƒæˆ–å¤œé£Žçš„åœ°æ–¹ï¼‰
Output Format: è¯·åŠ¡å¿…åªè¿”å›žä¸€æ®µçº¯ JSON æ ¼å¼æ•°æ®ï¼Œä¸è¦åŒ…å« Markdown æ ‡è®°ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š
{
  "title": "æ–¹æ¡ˆæ ‡é¢˜(å¯çˆ±ç‚¹)",
  "location": "æŽ¨èçš„å…·ä½“åœ°ç‚¹(å¿…é¡»çœŸå®žå­˜åœ¨)",
  "activity": "ä¸€å¥è¯çŽ©æ³•æ€»ç»“(è°ƒçš®æœ‰è¶£)",
  "reason": "æŽ¨èç†ç”±(ç»“åˆå…³ç³»å’Œé¢„ç®—)",
  "tags": ["æ ‡ç­¾1", "æ ‡ç­¾2", "æ ‡ç­¾3"]
}
`;
};

const getDatingAdvice = (params) => {
  return new Promise((resolve, reject) => {
    // ðŸ›¡ï¸ æ¨¡æ‹Ÿæ¼”ç¤ºæ¨¡å¼ï¼šå¦‚æžœæ²¡æœ‰ Keyï¼Œè¿”å›žå‡æ•°æ®ï¼Œé˜²æ­¢æŠ¥é”™å½±å“ä½“éªŒ
    if (!API_KEY) {
      console.warn("æœªé…ç½® API Keyï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®");
      setTimeout(() => {
        resolve({
          title: "æ¼”ç¤ºæ¨¡å¼ï¼šè½æ—¥é‡Žé¤",
          location: "æ»¨æ±Ÿæ£®æž—å…¬å›­ (æ¼”ç¤º)",
          activity: "å¸¦ä¸Šè“ç‰™éŸ³ç®±å’Œæ¯”è¨ï¼Œåœ¨å¤•é˜³ä¸‹æ¯”èµ›è°å…ˆæ•°åˆ°ç¬¬10æž¶é£žæœºã€‚",
          reason: "è¯·åœ¨ utils/api.js ä¸­é…ç½® API Key ä»¥èŽ·å–çœŸå®ž AI æŽ¨èã€‚",
          tags: ["#éœ€é…ç½®KEY", "#æ¨¡æ‹Ÿæ•°æ®", "#æ°›å›´æ„Ÿ"]
        });
      }, 2000);
      return;
    }

    wx.request({
      url: API_URL,
      method: "POST",
      header: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${API_KEY}`
      },
      data: {
        model: "deepseek-ai/DeepSeek-V3", // è¿™é‡Œä½¿ç”¨ SiliconFlow æä¾›çš„ DeepSeek V3 æ¨¡åž‹ï¼Œæ€§ä»·æ¯”æžé«˜
        messages: [
          { role: "user", content: generatePrompt(params) }
        ],
        temperature: 0.8, // 0.8 å¯ä»¥åœ¨ä¿æŒé€»è¾‘çš„åŒæ—¶å¢žåŠ ä¸€ç‚¹åˆ›æ„
        max_tokens: 512,
        response_format: { type: "json_object" } // å¼ºåˆ¶ JSON è¾“å‡ºï¼Œéžå¸¸é‡è¦
      },
      success: (res) => {
        // console.log("API Raw Response:", res); // è°ƒè¯•ç”¨
        if (res.statusCode === 200 && res.data.choices) {
          try {
            let content = res.data.choices[0].message.content;
            // åŒé‡ä¿é™©ï¼šæ¸…ç†å¯èƒ½å­˜åœ¨çš„ markdown ç¬¦å·
            content = content.replace(/```json/g, "").replace(/```/g, "").trim();
            const result = JSON.parse(content);
            resolve(result);
          } catch (e) {
            console.error("AI JSON è§£æžå¤±è´¥:", e);
            reject("AI æ•°æ®è§£æžå¤±è´¥ï¼Œè¯·é‡è¯•");
          }
        } else {
          console.error("API è¯·æ±‚å¤±è´¥:", res);
          // å¯ä»¥åœ¨è¿™é‡Œå¤„ç† Token ä¸è¶³ã€Key é”™è¯¯ç­‰æƒ…å†µ
          if (res.statusCode === 401) {
            reject("API Key æ— æ•ˆæˆ–è¿‡æœŸ");
          } else {
            reject("æœåŠ¡å™¨å¼€å°å·®äº†");
          }
        }
      },
      fail: (err) => {
        console.error("ç½‘ç»œé”™è¯¯:", err);
        reject("ç½‘ç»œè¿žæŽ¥å¤±è´¥");
      }
    });
  });
};

module.exports = {
  getDatingAdvice
};