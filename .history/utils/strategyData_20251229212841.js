// utils/strategyData.js

/**
 * ðŸ’Œ V6.0 æ ¸å¿ƒç­–ç•¥åº“ï¼šåŸºäºŽé«˜å¾· POI ç¼–ç çš„åœºæ™¯æ˜ å°„
 * * é€»è¾‘å˜è¿ï¼š
 * Old: è¾“å…¥ "é›¨å¤©" -> è¾“å‡ºå…³é”®è¯ "åšç‰©é¦†" -> é«˜å¾·æœåå­—å¸¦åšç‰©é¦†çš„ -> å®¹æ˜“æ­ªæ¥¼
 * New: è¾“å…¥ "é›¨å¤©" -> è¾“å‡ºç¼–ç  "140100" -> é«˜å¾·åªæ‰¾çœŸæ­£çš„åšç‰©é¦† -> ç»å¯¹ç²¾å‡†
 */

// === ðŸ“¦ åœºæ™¯ç­–ç•¥åŒ… (åŸºäºŽ CSV ç²¾é€‰) ===
const STRATEGY_PACKS = {
  // ðŸ›ï¸ [æ–‡åŒ–åŒ…]ï¼šé€‚åˆåˆè¯†ã€é›¨å¤©ã€éœ€è¦è¯é¢˜ (å®¤å†…/å®‰é™)
  CULTURE: {
    id: 'CULTURE',
    name: 'æ–‡åŒ–æ¼«æ­¥',
    // 140100=åšç‰©é¦†, 140400=ç¾Žæœ¯é¦†, 140200=å±•è§ˆé¦†, 140600=ç§‘æŠ€é¦†, 140700=å¤©æ–‡é¦†, 080603=å‰§åœº
    types: '140100|140400|140200|140600|140700|080603',
    desc: 'åœ¨è‰ºæœ¯ä¸ŽçŸ¥è¯†çš„æµ·æ´‹é‡Œï¼Œå¯»æ‰¾çµé­‚çš„å…±é¸£'
  },
  
  // ðŸ›ï¸ [æ¼«æ¸¸åŒ…]ï¼šé€‚åˆéšæ„é€›é€›ã€é¥­åŽã€é¿æš‘é¿å¯’ (å®¤å†…/å®‰å…¨)
  CITY_WALK: {
    id: 'CITY_WALK',
    name: 'åŸŽå¸‚æ¼«æ¸¸',
    // 060101=è´­ç‰©ä¸­å¿ƒ, 061001=æ­¥è¡Œè¡—, 061000=ç‰¹è‰²å•†ä¸šè¡—, 110204=çºªå¿µé¦†
    types: '060101|061001|061000|110204',
    desc: 'æ„Ÿå—åŸŽå¸‚çš„è„‰æï¼Œäº«å—è½»æ¾æƒ¬æ„çš„æ—¶å…‰'
  },

  // ðŸŒ¿ [è‡ªç„¶åŒ…]ï¼šé€‚åˆç™½å¤©ã€æ™´å¤©ã€æ”¾æ¾å¿ƒæƒ… (å®¤å¤–/é˜³å…‰)
  NATURE: {
    id: 'NATURE',
    name: 'æ‹¥æŠ±è‡ªç„¶',
    // 110102=åŠ¨ç‰©å›­, 110103=æ¤ç‰©å›­, 110200=é£Žæ™¯åèƒœ(é€šç”¨), 110201=ä¸–ç•Œé—äº§
    types: '110102|110103|110200|110201|110202', 
    desc: 'é€ƒç¦»å–§åš£ï¼ŒåŽ»å¤§è‡ªç„¶é‡Œå¤§å£å‘¼å¸'
  },

  // ðŸŽ¡ [çŽ©ä¹åŒ…]ï¼šé€‚åˆç ´å†°ã€ç”šè‡³æœ‰ç‚¹å°´å°¬æ—¶ (å®¤å¤–/æ´»è·ƒ)
  FUN_ACTIVE: {
    id: 'FUN_ACTIVE',
    name: 'æ´»åŠ›æ—¶å…‰',
    // 080501=æ¸¸ä¹åœº, 110104=æ°´æ—é¦†, 080106=æ»‘é›ªåœº, 080505=æ°´ä¸Šæ´»åŠ¨ä¸­å¿ƒ
    types: '080501|110104|080106|080505',
    desc: 'é‡Šæ”¾è·å°”è’™ï¼Œåœ¨æ¬¢ç¬‘ä¸­æ‹‰è¿‘è·ç¦»'
  },

  // ðŸŽ³ [äº’åŠ¨åŒ…]ï¼šé€‚åˆå¤©æ°”ä¸å¥½ä½†æƒ³åŠ¨çš„ (å®¤å†…/äº’åŠ¨)
  INDOOR_SPORT: {
    id: 'INDOOR_SPORT',
    name: 'å®¤å†…äº’åŠ¨',
    // 080102=ä¿é¾„çƒ, 080107=æºœå†°åœº, 080110=æ¸¸æ³³é¦†, 080118=ç¾½æ¯›çƒ, 080401=åº¦å‡æ‘
    types: '080102|080107|080110|080118|080401',
    desc: 'åŠ¨èµ·æ¥ï¼æ‹’ç»å†·åœºçš„æœ€ä½³æ–¹æ¡ˆ'
  },

  // ðŸŒ¹ [äº²å¯†åŒ…]ï¼šé€‚åˆå…³ç³»å‡çº§ã€æƒ…ä¾£ (ç§å¯†/æ°›å›´)
  INTIMATE: {
    id: 'INTIMATE',
    name: 'æµªæ¼«ç§è¯­',
    // 080602=éŸ³ä¹åŽ…, 071400=æ´—æµ´æŽ¨æ‹¿(éœ€ä¸¥æ ¼ç­›é€‰), 110208=æµ·æ»©
    types: '080602|071400|110208',
    desc: 'äº«å—åªå±žäºŽä¸¤ä¸ªäººçš„é™è°§æ—¶å…‰'
  }
};

/**
 * ðŸ§  æ ¸å¿ƒç®—æ³•ï¼šæ ¹æ®çŽ¯å¢ƒç”Ÿæˆç­–ç•¥é˜Ÿåˆ—
 * @param {Object} context - { weatherContext, relation, time }
 */
function getStrategies(context) {
  // ç®€å•è§£æžå‚æ•°
  const weatherText = context.weatherContext || '';
  const relation = context.relation || 'æš§æ˜§ä¸­';
  
  // 1. ðŸŒ¡ï¸ ç®€å•çš„çŽ¯å¢ƒæ„ŸçŸ¥
  const isBadWeather = /é›¨|é›ª|æš´|æ²™/.test(weatherText) || parseInt(weatherText) > 30;
  
  let queue = [];

  // 2. â›ˆï¸ å¤©æ°”ç»´åº¦ (ç‰©ç†å±‚)
  if (isBadWeather) {
    // åå¤©æ°” -> å¼ºåˆ¶å®¤å†…
    queue.push(STRATEGY_PACKS.CULTURE);       // åšç‰©é¦†/ç¾Žæœ¯é¦†
    queue.push(STRATEGY_PACKS.CITY_WALK);     // å•†åœº
    queue.push(STRATEGY_PACKS.INDOOR_SPORT);  // ä¿é¾„çƒ
  } else {
    // å¥½å¤©æ°” -> ä¼˜å…ˆå®¤å¤–ï¼Œå®¤å†…å…œåº•
    queue.push(STRATEGY_PACKS.NATURE);        // åŠ¨æ¤ç‰©å›­ (é¦–é€‰)
    queue.push(STRATEGY_PACKS.FUN_ACTIVE);    // æ¸¸ä¹åœº
    queue.push(STRATEGY_PACKS.CITY_WALK);     // é€›è¡— (å…œåº•)
  }

  // 3. â¤ï¸ å…³ç³»ç»´åº¦ (å¿ƒç†å±‚)
  // å¦‚æžœæ˜¯"å¦‚èƒ¶ä¼¼æ¼†"æˆ–"è€å¤«è€å¦»"ï¼Œå¯ä»¥åŠ ç‚¹äº²å¯†çš„
  if (['å¦‚èƒ¶ä¼¼æ¼†', 'ç›¸çˆ±ç›¸æ€', 'è€å¤«è€å¦»'].includes(relation)) {
    queue.unshift(STRATEGY_PACKS.INTIMATE); 
  } 
  
  // å¦‚æžœæ˜¯"åˆæ¬¡è§é¢"ï¼Œç¡®ä¿æ–‡åŒ–åŒ…åœ¨å‰é¢ï¼Œä¸”åŽ»æŽ‰å¤ªäº²å¯†çš„
  if (relation === 'åˆæ¬¡è§é¢') {
    queue = queue.filter(p => p.id !== 'INTIMATE');
    if (!queue.includes(STRATEGY_PACKS.CULTURE)) {
        queue.unshift(STRATEGY_PACKS.CULTURE);
    }
  }
  queue.sort(() => Math.random() - 0.5);

  return queue; // è¿”å›žç­–ç•¥å¯¹è±¡æ•°ç»„
}

module.exports = {
  getStrategies,
  STRATEGY_PACKS
};