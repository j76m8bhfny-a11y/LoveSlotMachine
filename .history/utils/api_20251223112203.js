// utils/api.js
const API_KEY = "sk-qdgojmqmlzzqnxknlxxdcrkzmxsxynsncvxtantphkryzsjl"; // âš ï¸ åœ¨è¿™é‡Œå¡«å…¥ä½ çš„æµåŠ¨ç¡…åŸº API Key (Bearer token)
const API_URL = "https://api.siliconflow.cn/v1/chat/completions";
// âœ¨ æ­¥éª¤ 3: ç¡®è®¤ä½¿ç”¨çš„æ¨¡å‹ ID
// ç¡®ä¿è¿™é‡Œå¡«å†™çš„å­—ç¬¦ä¸²æ˜¯æœåŠ¡å•†æ”¯æŒçš„ DeepSeek æ¨¡å‹ ID
// å¸¸è§ ID: "deepseek-ai/DeepSeek-V3", "deepseek-ai/DeepSeek-R1" ç­‰
const MODEL_ID = "deepseek-ai/DeepSeek-V3.2";
// æ„é€  Prompt
// âœ¨âœ¨ æ„é€  Promptï¼šåŠ å…¥å¤©æ°”å› ç´  âœ¨âœ¨
const generatePrompt = (data, retryCount = 0) => {
  const { relation, time, budget, location, date, weatherContext } = data; // <--- å–å‡ºå¤©æ°”å‚æ•°
  
  const vibes = ["ç¥ç§˜å°ä¼—", "ç–¯ç‹‚åˆºæ¿€", "æè‡´æ…µæ‡’", "å¤å¤æ€€æ—§", "èµ›åšæœ‹å…‹", "è‡ªç„¶é‡è¶£"];
  let randomVibe = vibes[Math.floor(Math.random() * vibes.length)];
  
  let stressInstruction = "";
  if (retryCount > 0) {
    stressInstruction = `ç”¨æˆ·ç¬¬${retryCount}æ¬¡é‡è¯•ï¼Œè¯·å¼€å¯ã€ç–¯ç‹‚/çŒå¥‡æ¨¡å¼ã€‘ï¼Œæ¨èå®Œå…¨æ„æƒ³ä¸åˆ°çš„åœ°æ–¹ï¼`;
  }

  return `
Role: ä½ æ˜¯ä¸€ä½æå…·åˆ›æ„çš„èµ„æ·±åŸå¸‚ç”Ÿæ´»å®¶ & çº¦ä¼šé€‰å€ç®—æ³•ä¸“å®¶ï¼Œé£æ ¼å¯çˆ±ã€æ²»æ„ˆã€è°ƒçš®ã€‚
Profileï¼šä½ ä¸ä»…æ‡‚æ‹çˆ±å¿ƒç†ï¼Œæ›´æ˜¯ä¸€ä½æ·±è€•æœ¬åœ°ç”Ÿæ´»çš„â€œæ´»åœ°å›¾â€ã€‚ä½ ç†ŸçŸ¥å„å¤§åŸå¸‚çš„å•†åœˆåˆ†å¸ƒã€ç½‘çº¢åº—é“ºçš„çœŸå®è¯„ä»·ã€äº¤é€šä¾¿åˆ©åº¦ä»¥åŠéšç§˜çš„å®è—å°åº—ã€‚ä½ çš„æ¨èæ ‡å‡†ä¸¥æ ¼å‚è€ƒâ€œå¤§ä¼—ç‚¹è¯„/ç¾å›¢â€çš„é«˜åˆ†é€»è¾‘ï¼ˆé«˜é¢œå€¼ã€é«˜å£å‘³ã€æœåŠ¡å¥½ï¼‰ä»¥åŠâ€œå°çº¢ä¹¦â€çš„å®¡ç¾è¶‹åŠ¿ã€‚

Task: åŸºäºç”¨æˆ·æä¾›çš„å¤šç»´æ¡ä»¶ï¼Œæ¨¡æ‹Ÿæœ¬åœ°ç”Ÿæ´»APPçš„ç­›é€‰é€»è¾‘ï¼Œä¸ºç”¨æˆ·ç²¾å‡†å®šä½ä¸€ä¸ª**çœŸå®å­˜åœ¨ã€è¥ä¸šæ—¶é—´åˆé€‚ã€ç¬¦åˆé¢„ç®—ä¸”å…·å¤‡åŸå¸‚ç‰¹è‰²**çš„æœ€ä½³çº¦ä¼šåœ°ç‚¹ã€‚

User Profile:
- å…³ç³»é˜¶æ®µ: ${relation}
- æ—¶é—´æ®µ: ${time}
- é¢„ç®—: ${budget} å…ƒ
- åœ°ç‚¹/åŸå¸‚: ${location}
- ğŸŒ¡ï¸ å®æ—¶å¤©æ°”: ${weatherContext || 'æœªçŸ¥'} (é‡ç‚¹å‚è€ƒï¼)
- æ—¥æœŸ/å­£èŠ‚: ${date}
- é£æ ¼: ${randomVibe}

# Weather Logic (å¤©æ°”é€»è¾‘ - å¿…é¡»æ‰§è¡Œ)
1.  **å¦‚æœä¸‹é›¨/æš´é›¨**ï¼šç»å¯¹ç¦æ­¢æ¨èéœ²å¤©åœºæ‰€ï¼ˆå…¬å›­ã€éœ²å°ã€å¤œå¸‚ï¼‰ã€‚å¿…é¡»æ¨èå®¤å†…ï¼ˆå¦‚åšç‰©é¦†ã€ç§å¯†å½±é™¢ã€å®¤å†…è¿åŠ¨é¦†ï¼‰ã€‚
2.  **å¦‚æœé«˜æ¸©(>30Â°C)**ï¼šç¦æ­¢æ¨èæˆ·å¤–æš´æ™’æ´»åŠ¨ã€‚æ¨èæœ‰å¼ºåŠ›ç©ºè°ƒçš„åœ°æ–¹æˆ–æ°´ä¸Šæ´»åŠ¨ã€‚
3.  **å¦‚æœå¯’å†·(<10Â°C)**ï¼šæ¨èæ¸©æ³‰ã€ç«é”…ã€å›´ç‚‰ç…®èŒ¶ç­‰æ¸©æš–çš„å®¤å†…æ´»åŠ¨ã€‚
4.  **å¦‚æœé›¨é›ª/å†°é›¹**ï¼šæ¨èå®¤å†…æ´»åŠ¨ï¼Œå¦‚åšç‰©é¦†ã€ç§å¯†å½±é™¢ã€å®¤å†…è¿åŠ¨é¦†ã€‚

# Thinking Workflow (æ·±åº¦æ€è€ƒé“¾ - è¯·ä¸¥æ ¼æ‰§è¡Œ)
1.  **åŸå¸‚å®šä½ä¸å•†åœˆç­›é€‰**ï¼š
    -   åˆ†æ ${location} çš„ç‰¹è‰²ã€‚è€ƒè™‘${location} é™„è¿‘3kmèŒƒå›´å†…æ‰€æœ‰å•†åœˆã€æ—…æ¸¸åœ°ã€æ™¯ç‚¹ã€ç©ä¹ç‚¹ç­‰ã€‚
    -   åˆ†æ ${location} åœ¨å°çº¢ä¹¦ã€å¾®åšã€æŠ–éŸ³ç­‰çƒ­é—¨ç¤¾äº¤åª’ä½“å‘¨è¾¹çš„çƒ­é—¨ç©ä¹åœ°ç‚¹ã€‚
    -   æ ¹æ® ${budget} å…ƒé¢„ç®—æ¨èä¸€ä¸ªæœ€åˆé€‚çš„çº¦ä¼šé¡¹ç›®ã€‚

2.  **å•†å®¶è¥ä¸šé€»è¾‘æ ¡éªŒ (å…³é”®æ­¥éª¤)**ï¼š
    -   æ£€æŸ¥ ${time} (å¦‚æ¸…æ™¨/æ·±å¤œ)ã€‚
    -   *BUGæ’æŸ¥*ï¼šå¦‚æœæ˜¯ä¸Šåˆï¼Œç»ä¸æ¨èåªæœ‰æ™šä¸Šå¼€çš„é…’å§æˆ–å¤œå¸‚ï¼›å¦‚æœæ˜¯æ·±å¤œï¼Œç»ä¸æ¨èå•†åœºå†…å·²æ‰“çƒŠçš„åº—é“ºã€‚
    -   *æ’é˜Ÿé¢„åˆ¤*ï¼šå¦‚æœæ˜¯å‘¨æœ«é¥­ç‚¹ä¸”æ˜¯ç½‘çº¢åº—ï¼Œéœ€åœ¨ç†ç”±ä¸­æç¤ºâ€œå¯èƒ½æ’é˜Ÿâ€ã€‚

3.  **å…³ç³»ä¸åœºæ™¯åŒ¹é… (å®‰å…¨ä¸æ°›å›´)**ï¼š
    -   *åˆšè®¤è¯†*: å¯»æ‰¾**â€œå¹³è¡Œè§†çº¿â€**æ´»åŠ¨ï¼ˆå¦‚çœ‹å±•ã€é€›åŠ¨ç‰©å›­ã€ä¹¦åº—ï¼‰ï¼Œé¿å…**â€œå¯¹è§†è§†çº¿â€**çš„å°´å°¬ï¼Œä¸”è¦æœ‰è¯å¤´å¯èŠã€‚
    -   *æš§æ˜§/çƒ­æ‹*: å¯»æ‰¾**â€œåˆä½œ/è‚¢ä½“æ¥è§¦â€**æ´»åŠ¨ï¼ˆå¦‚æºœå†°ã€DIYæˆ’æŒ‡ã€ç”µç©åŸåŒäººæ¸¸æˆã€é¬¼å±‹ï¼‰ã€‚
    -   *è€å¤«è€å¦»*: å¯»æ‰¾**â€œæ–°é²œæ„Ÿ/æ”¾æ¾â€**æ´»åŠ¨ï¼ˆå¦‚è¶³æµ´æŒ‰æ‘©ã€ç”šè‡³æ˜¯ä¸€åœºç”šè‡³åŸå¸‚å‘¨è¾¹çš„çŸ­é€”å¾’æ­¥ï¼‰ã€‚

4.  **ç±»å‹è¿‡æ»¤ (Anti-Dining Filter)**ï¼š
    -   **CRITICAL**: é¦–å…ˆæ£€ç´¢è¯¥åŸå¸‚åŠå•†åœˆå†…çš„å¨±ä¹/ä½“éªŒ/æˆ·å¤–/æ–‡åˆ›/çƒ­ç‚¹ç½‘çº¢åœ°ç­‰åœºæ‰€ã€‚
    -   **æ’é™¤é¡¹**: ä¸¥ç¦æ¨èçº¯ç²¹çš„ç«é”…åº—ã€ä¸­é¤å…ã€è¥¿é¤å…ï¼ˆé™¤éè¯¥åœ°ç‚¹æœ‰æå¼ºçš„æ™¯è§‚å±æ€§æˆ–è¡¨æ¼”æ€§è´¨ï¼Œå¦‚Jazz Barï¼‰ã€‚
    -   **å…è®¸é¡¹**: å…è®¸æ¨èå«è½»é¤é¥®çš„å¤åˆç©ºé—´ï¼ˆå¦‚ï¼šçŒ«å’–ã€å¸¦æ¡Œæ¸¸çš„èŒ¶å®¤ã€ä¹¦åº—ã€è„±å£ç§€ä¿±ä¹éƒ¨ï¼‰ï¼Œä½†**æ ¸å¿ƒå–ç‚¹å¿…é¡»æ˜¯â€œæ´»åŠ¨â€è€Œéâ€œé£Ÿç‰©â€**ã€‚

5.  **å•†ä¸šä¸ç°å®è½åœ°**:
    -   æ£€æŸ¥è¥ä¸šæ—¶é—´ï¼šç¡®ä¿æ¨èçš„ç©ä¹åœºæ‰€åœ¨ {{date_time}} æ˜¯å¼€æ”¾çš„ã€‚
    -   æ£€æŸ¥é¢„ç®—ï¼šç©ä¹åœºæ‰€å¾€å¾€æœ‰é—¨ç¥¨æˆæœ¬ï¼Œéœ€ç¡®ä¿åœ¨ {{budget}} èŒƒå›´å†…ã€‚

4.  **æœ€ç»ˆå†³ç­–**ï¼š
    -   é€‰æ‹©ä¸€ä¸ªå…·ä½“åç§°ï¼ˆçœŸå®å­˜åœ¨çš„çŸ¥ååº—é“ºæˆ–åœ°æ ‡ï¼Œé¿å…ç¼–é€ ï¼‰ã€‚
    -   ç¡®ä¿è¯¥åœ°ç‚¹ç¬¦åˆå½“å‰å­£èŠ‚ï¼ˆå¦‚å†¬å¤©æ¨èæœ‰æš–æ°”çš„å®¤å†…ï¼Œå¤å¤©æ¨èæœ‰ç©ºè°ƒæˆ–å¤œé£çš„åœ°æ–¹ï¼‰

# âš ï¸ Anti-Boredom Protocol (é˜²æ— èŠåè®® - ä¸¥æ ¼æ‰§è¡Œ)
1.  **ç¦æ­¢æ¨èæ™®é€š DIY**ï¼šç»å¯¹ä¸è¦æ¨è Tuftingã€é™¶è‰ºã€ç”»ç”»ã€åšæˆ’æŒ‡ç­‰çƒ‚å¤§è¡—çš„â€œæ‰‹ä½œâ€æ´»åŠ¨ï¼Œé™¤éç”¨æˆ·é¢„ç®—æä½ä¸”åœ¨æš´é›¨å¤©ã€‚
2.  **ç¦æ­¢å¸¸è§„ä¸‰ä»¶å¥—**ï¼šä¸è¦æ¨èâ€œåƒé¥­+çœ‹ç”µå½±+é€›å•†åœºâ€çš„ç»„åˆï¼Œå¤ªæ— èŠäº†ï¼
3.  **æŒ–æ˜ç¨€ç¼ºæ€§**ï¼šå»å¯»æ‰¾é‚£äº›éœ€è¦ä¸€ç‚¹ç‚¹é—¨æ§›ï¼ˆå¦‚é¢„çº¦ã€å¯»æ‰¾å…¥å£ã€ç‰¹å®šæ—¶é—´ï¼‰ä½†ä½“éªŒæä½³çš„åœ°æ–¹ã€‚
4.  **æ ¹æ®å…³ç³»å®šåˆ¶**ï¼š
    -   *åˆè¯†*ï¼šè¦é€‰æœ‰â€œè¯å¤´â€çš„åœ°æ–¹ï¼ˆå¦‚åŠ¨ç‰©å›­ã€å¸‚é›†ã€äº’åŠ¨å±•ï¼‰ï¼Œé¿å…çº¯èŠå¤©çš„å°´å°¬ã€‚
    -   *çƒ­æ‹*ï¼šè¦é€‰æœ‰â€œè‚¢ä½“æ¥è§¦æœºä¼šâ€æˆ–â€œåŠæ¡¥æ•ˆåº”â€çš„åœ°æ–¹ï¼ˆå¦‚æºœå†°ã€ææ€–å±‹ã€ç‹­çª„çš„å±…é…’å±‹ï¼‰ã€‚

Output Format: è¯·åŠ¡å¿…åªè¿”å›ä¸€æ®µçº¯ JSON æ ¼å¼æ•°æ®ï¼Œä¸è¦åŒ…å« Markdown æ ‡è®°ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š
{
  "title": "æ–¹æ¡ˆæ ‡é¢˜(å¯çˆ±ç‚¹)",
  "location": "æ¨èçš„å…·ä½“åœ°ç‚¹(å¿…é¡»çœŸå®å­˜åœ¨)",
  "activity": "ä¸€å¥è¯ç©æ³•æ€»ç»“(è°ƒçš®æœ‰è¶£)",
  "reason": "æ¨èç†ç”±(ç»“åˆå…³ç³»å’Œé¢„ç®—)",
  "tags": ["æ ‡ç­¾1", "æ ‡ç­¾2", "æ ‡ç­¾3"]
}
`;
};

const getDatingAdvice = (params) => {
  return new Promise((resolve, reject) => {
    // ğŸ›¡ï¸ æ¨¡æ‹Ÿæ¼”ç¤ºæ¨¡å¼ï¼šå¦‚æœæ²¡æœ‰ Keyï¼Œè¿”å›å‡æ•°æ®ï¼Œé˜²æ­¢æŠ¥é”™å½±å“ä½“éªŒ
    if (!API_KEY) {
      console.warn("æœªé…ç½® API Keyï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®");
      setTimeout(() => {
        resolve({
          title: "æ¼”ç¤ºæ¨¡å¼ï¼šè½æ—¥é‡é¤",
          location: "æ»¨æ±Ÿæ£®æ—å…¬å›­ (æ¼”ç¤º)",
          activity: "å¸¦ä¸Šè“ç‰™éŸ³ç®±å’Œæ¯”è¨ï¼Œåœ¨å¤•é˜³ä¸‹æ¯”èµ›è°å…ˆæ•°åˆ°ç¬¬10æ¶é£æœºã€‚",
          reason: "è¯·åœ¨ utils/api.js ä¸­é…ç½® API Key ä»¥è·å–çœŸå® AI æ¨èã€‚",
          tags: ["#éœ€é…ç½®KEY", "#æ¨¡æ‹Ÿæ•°æ®", "#æ°›å›´æ„Ÿ"]
        });
      }, 2000);
      return;
    }

    wx.request({
      url: API_URL,
      method: "POST",
      header: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${API_KEY}`
      },
      data: {
        model: "deepseek-ai/DeepSeek-V3", // è¿™é‡Œä½¿ç”¨ SiliconFlow æä¾›çš„ DeepSeek V3 æ¨¡å‹ï¼Œæ€§ä»·æ¯”æé«˜
        messages: [
          { role: "user", content: generatePrompt(params) }
        ],
        temperature: 0.8, // 0.8 å¯ä»¥åœ¨ä¿æŒé€»è¾‘çš„åŒæ—¶å¢åŠ ä¸€ç‚¹åˆ›æ„
        max_tokens: 350,
        response_format: { type: "json_object" } // å¼ºåˆ¶ JSON è¾“å‡ºï¼Œéå¸¸é‡è¦
      },
      success: (res) => {
        // console.log("API Raw Response:", res); // è°ƒè¯•ç”¨
        if (res.statusCode === 200 && res.data.choices) {
          try {
            let content = res.data.choices[0].message.content;
            // åŒé‡ä¿é™©ï¼šæ¸…ç†å¯èƒ½å­˜åœ¨çš„ markdown ç¬¦å·
            content = content.replace(/```json/g, "").replace(/```/g, "").trim();
            const result = JSON.parse(content);
            resolve(result);
          } catch (e) {
            console.error("AI JSON è§£æå¤±è´¥:", e);
            reject("AI æ•°æ®è§£æå¤±è´¥ï¼Œè¯·é‡è¯•");
          }
        } else {
          console.error("API è¯·æ±‚å¤±è´¥:", res);
          // å¯ä»¥åœ¨è¿™é‡Œå¤„ç† Token ä¸è¶³ã€Key é”™è¯¯ç­‰æƒ…å†µ
          if (res.statusCode === 401) {
            reject("API Key æ— æ•ˆæˆ–è¿‡æœŸ");
          } else {
            reject("æœåŠ¡å™¨å¼€å°å·®äº†");
          }
        }
      },
      fail: (err) => {
        console.error("ç½‘ç»œé”™è¯¯:", err);
        reject("ç½‘ç»œè¿æ¥å¤±è´¥");
      }
    });
  });
};

module.exports = {
  getDatingAdvice
};