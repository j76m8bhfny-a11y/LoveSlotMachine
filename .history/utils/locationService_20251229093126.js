// utils/locationService.js
const amapFile = require('./amap-wx.js');

// âš ï¸ å¡«å…¥ä½ çš„é«˜å¾· Key
const AMAP_KEY = 'f203aa448fe4f1ebda0a2d52babdaeaf'; 
const myAmapFun = new amapFile.AMapWX({ key: AMAP_KEY });

// ==========================================
// 1. ğŸ” æœç´¢è¯ç²¾å‡†æ˜ å°„è¡¨ (è§£å†³æœä¸åˆ°)
// ==========================================
// æ ¸å¿ƒé€»è¾‘ï¼šä¸è¦æœâ€œåŠ¨ä½œâ€ï¼Œè¦æœâ€œåœºæ‰€ç±»å‹â€
// æŠ€å·§ï¼šç”¨ | åˆ†éš”ï¼Œä¸€æ¬¡æœå¤šä¸ªè¯ï¼Œæé«˜å•æ¬¡å‘½ä¸­ç‡
const SEARCH_MAPPING = {
  // â›°ï¸ æˆ·å¤–/è¿åŠ¨
  'çˆ¬å±±': 'é£æ™¯åèƒœ|æ£®æ—å…¬å›­|å±±å³°|è‡ªç„¶ä¿æŠ¤åŒº',
  'æ»‘é›ª': 'æ»‘é›ªåœº|å†°é›ªä¸–ç•Œ',
  'æºœå†°': 'æ»‘å†°åœº|æºœå†°åœº',
  'æ¸¸æ³³': 'æ¸¸æ³³é¦†|æ’æ¸©æ³³æ± ',
  'å°„ç®­': 'å°„ç®­é¦†|å°„ç®­ä¿±ä¹éƒ¨',
  'éª‘è¡Œ': 'ç»¿é“|å…¬å›­|æ¹–ç•”',
  'éœ²è¥': 'éœ²è¥åœ°|æˆ¿è½¦è¥åœ°|éƒŠé‡å…¬å›­',
  'é‡é¤': 'æ¤ç‰©å›­|æ¹¿åœ°å…¬å›­|è‰åª',
  
  // ğŸ¨ å®¤å†…/ä½“éªŒ
  'DIY': 'é™¶è‰º|æ‰‹å·¥åŠ|ç”»å®¤|DIY|çƒ˜ç„™', 
  'çŒ«å’–': 'çŒ«å’–|çŒ«å’ª|å® ç‰©å’–å•¡',
  'ç‹—å’–': 'ç‹—å’–|å® ç‰©åº—',
  'ç§å½±': 'ç§äººå½±é™¢|å½±å§|ç‚¹æ’­å½±é™¢',
  'å¯†å®¤': 'å¯†å®¤é€ƒè„±|å®æ™¯å¨±ä¹',
  'å‰§æœ¬æ€': 'å‰§æœ¬æ€|æ¡Œæ¸¸',
  'ç”µç©': 'ç”µç©åŸ|æ¸¸æˆå…',
  
  // ğŸ› ä¼‘é—²
  'æ´—æµ´': 'æ´—æµ´ä¸­å¿ƒ|æ±¤æ³‰|æ±—è’¸|æ°´ç–—',
  'æ¸©æ³‰': 'æ¸©æ³‰åº¦å‡|æ³¡æ±¤',
  'æŒ‰æ‘©': 'è¶³ç–—|æŒ‰æ‘©|æ¨æ‹¿', // æ³¨æ„å®¡æ ¸é£é™©ï¼Œä½†è¿™ç¡®å®æ˜¯åœ°ç‚¹
  
  // ğŸ›ï¸ æ–‡åŒ–
  'çœ‹å±•': 'ç¾æœ¯é¦†|è‰ºæœ¯ä¸­å¿ƒ|å±•è§ˆé¦†|åšç‰©é¦†',
  'ä¹¦åº—': 'ä¹¦åº—|å›¾ä¹¦é¦†|ä¹¦å±€',
  'å¯ºåº™': 'å¯ºåº™|é“è§‚|å¤å¯º'
};

// ==========================================
// 2. ğŸ›¡ï¸ è¯·æ±‚é˜Ÿåˆ—ç³»ç»Ÿ (å½»åº•è§£å†³ 10021)
// ==========================================
// å³ä½¿å‰ç«¯ç¬é—´å‘10ä¸ªè¯·æ±‚ï¼Œè¿™é‡Œä¹Ÿä¼šä¸€ä¸ªä¸€ä¸ªæ…¢æ…¢å‘
let requestQueue = [];
let isProcessing = false;
const MIN_INTERVAL = 600; // âš ï¸ å®‰å…¨é—´éš”ï¼š600ms (æ¯”500msæ›´ç¨³)

function processQueue() {
  if (isProcessing || requestQueue.length === 0) return;
  
  isProcessing = true;
  const { resolve, reject, params } = requestQueue.shift();

  // æ‰§è¡Œé«˜å¾·æœç´¢
  myAmapFun.getPoiAround({
    ...params,
    success: (data) => {
      resolve(data);
      scheduleNext();
    },
    fail: (info) => {
      // å³ä½¿å¤±è´¥ï¼Œä¹ŸæŠŠå®ƒå½“åšä¸€ç§ç»“æœè¿”å›ï¼ˆåªä¸è¿‡æ˜¯ç©ºï¼‰ï¼Œé˜²æ­¢ Promise.all æŒ‚æ‰
      console.warn("é«˜å¾·APIå¾®æŠ¥é”™(å¯å¿½ç•¥):", info);
      resolve({ poisData: [] }); 
      scheduleNext();
    }
  });
}

function scheduleNext() {
  setTimeout(() => {
    isProcessing = false;
    processQueue();
  }, MIN_INTERVAL);
}

// ==========================================
// 3. å¯¹å¤–æ¥å£
// ==========================================
function searchNearby(keyword, location) {
  return new Promise((resolve, reject) => {
    // 1. æŸ¥å­—å…¸æ˜ å°„
    // å¦‚æœæ²¡æœ‰æ˜ å°„ï¼Œå°±ä¿ç•™åŸè¯ï¼Œä½†åŠ ä¸Šâ€œ|æ¨èâ€è¯•å›¾å¢åŠ å¬å›
    const realQuery = SEARCH_MAPPING[keyword] || `${keyword}|ç©ä¹`; 
    
    console.log(`[Location] æœ:${keyword} -> å®é™…å‘:${realQuery}`);

    // 2. æ„é€ å‚æ•°
    const params = {
      query_keywords: realQuery,
      location: location,
      radius: 50000,   // 50å…¬é‡Œ
      sortrule: 'weight', // æŒ‰çƒ­åº¦ï¼Œä¿è¯æœåˆ°çš„æ˜¯â€œå¤§åº—â€
      offset: 25,      // ä¸€æ¬¡æ‹¿25ä¸ªï¼Œå¢åŠ è¿‡æ»¤åçš„å­˜æ´»ç‡
      extensions: 'all' // è·å–è¯¦ç»†ä¿¡æ¯
    };

    // 3. åŠ å…¥é˜Ÿåˆ—ï¼Œè€Œä¸æ˜¯ç›´æ¥å‘èµ·
    requestQueue.push({ resolve, reject, params });
    processQueue();
  });
}

module.exports = { searchNearby };